# FLOAT 训练脚本使用说明

## 简化版训练脚本

新的 `train.py` 仿照 `meanflow.py` 的简洁风格重写，移除了复杂的类结构，使代码更加直观易懂。

## 主要特性

### 1. 简洁的代码结构
- 移除了复杂的 `FLOATTrainer` 类
- 使用函数式编程风格
- 代码行数从 521 行减少到约 250 行

### 2. 核心功能保留
- ✅ 模型初始化和训练
- ✅ 数据加载和预处理
- ✅ 损失计算（Rectified Flow）
- ✅ 优化器和学习率调度
- ✅ 检查点保存和恢复
- ✅ 训练日志记录
- ✅ 样本生成和验证

### 3. 使用 Accelerate 库
- 支持混合精度训练（FP16）
- 支持多 GPU 训练
- 自动处理设备分配

## 使用方法

### 基本训练
```bash
cd /home/mli374/float/training
conda activate FLOAT
python train.py
```

### 自定义参数
```bash
python train.py --steps 100000 --batch-size 16 --lr 2e-4 --data-root datasets/ravdess_processed
```

### 参数说明
- `--steps`: 训练步数（默认：200000）
- `--batch-size`: 批次大小（默认：8）
- `--lr`: 学习率（默认：1e-4）
- `--data-root`: 数据根目录（默认：datasets/ravdess_processed）

## 输出文件

### 检查点
- `checkpoints/step_*.pt`: 定期保存的检查点
- `checkpoints/final_step_*.pt`: 最终模型

### 样本
- `samples/step_*.pt`: 训练过程中生成的样本

### 日志
- `training_log.txt`: 训练日志

## 与原版本的主要区别

| 特性 | 原版本 | 简化版本 |
|------|--------|----------|
| 代码结构 | 复杂的类结构 | 函数式编程 |
| 代码行数 | 521 行 | ~250 行 |
| 配置管理 | 复杂的配置类 | 简单的字典 |
| 错误处理 | 详细的异常处理 | 基本的错误处理 |
| 验证功能 | 完整的验证循环 | 简化的样本生成 |
| 早停机制 | 支持 | 移除（可手动停止） |
| Wandb 集成 | 支持 | 移除（可手动添加） |

## 注意事项

1. **数据路径**: 确保数据路径正确，默认使用 `datasets/ravdess_processed`
2. **GPU 内存**: 根据 GPU 内存调整批次大小
3. **训练时间**: 完整训练需要较长时间，建议先小规模测试
4. **检查点**: 定期保存检查点，避免训练中断丢失进度

## 扩展建议

如果需要更多功能，可以考虑添加：
- Wandb 日志记录
- 更详细的验证指标
- 早停机制
- 学习率调度器
- 数据增强
